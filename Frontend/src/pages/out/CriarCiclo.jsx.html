<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: CriarCiclo.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: CriarCiclo.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// src/CriarCiclo.jsx
import React, { useState } from 'react';
import { useForm } from "react-hook-form";
import { yupResolver } from "@hookform/resolvers/yup";
import * as Yup from "yup";
import { useNavigate } from "react-router-dom";
import { addNewCiclo } from "../../features/user/ciclosSlice";
import "./criar-ciclo.css";
import NavBar from "../../Components/NavBar";
import { selectAllUsers } from "../../features/user/usersSlice";
import { useSelector, useDispatch } from "react-redux";
import Title from "../../Components/Title";
import { Container, Box, Chip, Stack } from "@mui/material";
import SelectUsers from "../../Components/SelectUsers";

// Esquema de validação do formulário com Yup
const validationSchema = Yup.object().shape({
  titulo: Yup.string().required("Título é obrigatório"),
  tipo: Yup.string().required("Tipo de ciclo é obrigatório"),
  inicio: Yup.string().required("Data de início é obrigatória"),
  termino: Yup.string().required("Data de término é obrigatória"),
  // Ambos, Avaliadores e Avaliados, são arrays de emails
  avaliadores: Yup.array().min(1, "Selecione ao menos um avaliador").required(),
  avaliados: Yup.array().min(1, "Selecione ao menos um avaliado").required(), 
});

/**
 * Página "Criar Ciclo".
 *
 * Renderiza um formulário completo para a criação de um novo Ciclo de Revisão.
 * Utiliza `react-hook-form` e `yup` para gerenciamento e validação.
 * Permite selecionar 'Avaliadores' (Gestores) e 'Avaliados' (Funcionários)
 * a partir de dados do Redux.
 * Despacha a ação `addNewCiclo` do Redux ao submeter.
 *
 * @returns {JSX.Element} A página de criação de ciclo.
 */
export default function CriarCiclo() {
  const dispatch = useDispatch();
  const navigate = useNavigate();
  const userList = useSelector(selectAllUsers);
  
  // Listas filtradas por cargo
  const gestoresList = userList.filter((user) => user.cargo === "gestor");
  const funcionariosList = userList.filter((user) => user.cargo === "funcionario");

  // Estados locais para controlar o seletor e permitir o reset
  const [selectedAvaliadoEmail, setSelectedAvaliadoEmail] = useState(""); 
  const [selectedAvaliadorEmail, setSelectedAvaliadorEmail] = useState(""); // NOVO ESTADO

  // Prepara as opções no formato {label: nome, value: email}
  const avaliadosOptions = funcionariosList.map((user) => ({
    label: user.nome,
    value: user.email,
  }));

  const avaliadoresOptions = gestoresList.map((user) => ({ // NOVO: Opções de Avaliadores
    label: user.nome,
    value: user.email,
  }));

  // Configuração do React Hook Form
  const {
    handleSubmit,
    setValue, // Usado para atualizar o valor do formulário programaticamente
    watch, // Usado para observar os valores dos arrays
    register, // Mantido para campos simples
    formState: { errors, isSubmitting },
  } = useForm({
    resolver: yupResolver(validationSchema),
    defaultValues: {
      avaliadores: [], // Array de emails de gestores
      avaliados: [],   // Array de emails de funcionários
    },
  });

  // Observa os arrays de emails selecionados no estado do formulário
  const avaliados = watch("avaliados"); 
  const avaliadores = watch("avaliadores"); 

  // Função auxiliar para obter o nome do usuário a partir do email para o label do Chip
  const getUsernameByEmail = (email) => {
    const user = userList.find(u => u.email === email);
    return user ? user.nome : email;
  }

  // Lógica para Avaliados (Funcionários)
  const handleAvaliadoSelect = (newEmail) => {
    // Adiciona o email ao array se ele não existir
    if (newEmail &amp;&amp; !avaliados.includes(newEmail)) {
        setValue("avaliados", [...avaliados, newEmail], { shouldValidate: true });
    }
    setSelectedAvaliadoEmail(""); // Reseta o seletor
  };

  const handleDeleteAvaliado = (emailToDelete) => {
    // Remove o email do array (Chip)
    const newAvaliados = avaliados.filter((email) => email !== emailToDelete);
    setValue("avaliados", newAvaliados, { shouldValidate: true });
  };
  
  // NOVO: Lógica para Avaliadores (Gestores)
  const handleAvaliadorSelect = (newEmail) => {
    if (newEmail &amp;&amp; !avaliadores.includes(newEmail)) {
        setValue("avaliadores", [...avaliadores, newEmail], { shouldValidate: true });
    }
    setSelectedAvaliadorEmail("");
  };

  const handleDeleteAvaliador = (emailToDelete) => {
    const newAvaliadores = avaliadores.filter((email) => email !== emailToDelete);
    setValue("avaliadores", newAvaliadores, { shouldValidate: true });
  };

  // Função de submissão do formulário
  const onSubmit = async (data) => {
    try {
      // data.avaliados e data.avaliadores já são arrays, prontos para envio.
      await dispatch(addNewCiclo(data)).unwrap();

      alert("Ciclo criado com sucesso!");
      navigate("/ciclo-revisao");
    } catch (err) {
      alert("Falha ao criar o ciclo.");
      console.error(err);
    }
  };

  return (
    &lt;Box sx={{ backgroundColor: "white", minHeight: "100vh" }}>
      &lt;Container
        className="cabecalho"
        maxWidth="lg"
        sx={{
          display: "flex", 
          alignItems: "center", 
          justifyContent: "flex-start", 
          gap: 60, 
          py: 3, 
        }}
      >
        &lt;button
          type="button"
          className="botao-voltar"
          aria-label="Voltar"
          onClick={() => navigate("/ciclo-revisao")}
        >
          &lt;svg width="24" height="24" fill="none">
            &lt;path
              d="M15 18l-6-6 6-6"
              stroke="#7ED6C0"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            />
          &lt;/svg>
        &lt;/button>
        &lt;Title className="titulo-pagina" titulo={"Criar Ciclo"} />
      &lt;/Container>

      &lt;main className="form-container">
        &lt;form
          className="ciclo-form"
          onSubmit={handleSubmit(onSubmit)}
        >
          {/* ... (Campos Título, Tipo, Início, Término) ... */}
          &lt;div className="form-group">
            &lt;label>Título do Ciclo de Revisão&lt;/label>
            &lt;input
              {...register("titulo")}
              placeholder="Ex: Avaliação de Desempenho Q1"
            />
            {errors.titulo &amp;&amp; (
              &lt;p className="error-message">{errors.titulo.message}&lt;/p>
            )}
          &lt;/div>
          &lt;div className="form-group">
            &lt;label>Tipo de Ciclo&lt;/label>
            &lt;select {...register("tipo")}>
              &lt;option value="">Selecione...&lt;/option>
              &lt;option value="Mensal">Mensal&lt;/option>
              &lt;option value="Semestral">Semestral&lt;/option>
              &lt;option value="Anual">Anual&lt;/option>
            &lt;/select>
            {errors.tipo &amp;&amp; (
              &lt;p className="error-message">{errors.tipo.message}&lt;/p>
            )}
          &lt;/div>
          &lt;div className="form-group">
            &lt;label>Data de Início&lt;/label>
            &lt;input type="date" {...register("inicio")} />
            {errors.inicio &amp;&amp; (
              &lt;p className="error-message">{errors.inicio.message}&lt;/p>
            )}
          &lt;/div>
          &lt;div className="form-group">
            &lt;label>Data de Término&lt;/label>
            &lt;input type="date" {...register("termino")} />
            {errors.termino &amp;&amp; (
              &lt;p className="error-message">{errors.termino.message}&lt;/p>
            )}
          &lt;/div>
          
          {/* NOVO: Seção de Avaliadores (Gestores) com Seletor e Chips */}
          &lt;div className="form-group">
            &lt;label>Avaliador&lt;/label>
            &lt;SelectUsers
              options={avaliadoresOptions}
              value={selectedAvaliadorEmail}
              onChange={handleAvaliadorSelect}
              selectLabel="Adicionar Avaliador"
            />
            
            &lt;Stack direction="row" spacing={1} sx={{ mt: 2, flexWrap: 'wrap', gap: 1 }}>
              {avaliadores.map((email) => (
                &lt;Chip
                  key={email}
                  label={getUsernameByEmail(email)}
                  onDelete={() => handleDeleteAvaliador(email)}
                  color="secondary" // Cor diferente para distinção
                  variant="outlined"
                />
              ))}
            &lt;/Stack>
            
            {errors.avaliadores &amp;&amp; (
              &lt;p className="error-message">{errors.avaliadores.message}&lt;/p>
            )}
          &lt;/div>

          {/* Seção de Avaliados (Funcionários) com Seletor e Chips */}
          &lt;div className="form-group">
            &lt;label>Avaliados&lt;/label>
            &lt;SelectUsers
              options={avaliadosOptions}
              value={selectedAvaliadoEmail}
              onChange={handleAvaliadoSelect}
              selectLabel="Adicionar Avaliado"
            />
            
            &lt;Stack direction="row" spacing={1} sx={{ mt: 2, flexWrap: 'wrap', gap: 1 }}>
              {avaliados.map((email) => (
                &lt;Chip
                  key={email}
                  label={getUsernameByEmail(email)}
                  onDelete={() => handleDeleteAvaliado(email)}
                  color="primary"
                  variant="outlined"
                />
              ))}
            &lt;/Stack>
            
            {errors.avaliados &amp;&amp; (
              &lt;p className="error-message">{errors.avaliados.message}&lt;/p>
            )}
          &lt;/div>
          

          &lt;button type="submit" className="main-btn" disabled={isSubmitting}>
            {isSubmitting ? "Salvando..." : "Salvar Ciclo"}
          &lt;/button>
        &lt;/form>
      &lt;/main>
      &lt;NavBar />
    &lt;/Box>
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Nov 20 2025 12:19:53 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
